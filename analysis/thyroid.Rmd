---
title: "Thyroid investigation"
author: "Ethan de Villiers"
date: "`r Sys.Date()`"
output: html_document
---

``` {r Init, echo=FALSE} 

library(devtools) # Essential for Aurum integration
library(tidyverse)  # streamlining R coding since 2016
library(ggplot2) # Used in graphing
library(ggridges) # very beautiful must have ridges

install_github("Exeter-Diabetes/CPRD-analysis-package") # Package created by Exeter University to work with CPRD data
library(aurum)
cprd = CPRDData$new(cprdEnv = "test-remote", cprdConf = '~/RStudio/aurum.yaml')
```

``` {r Pulling Thyroid Cohort}
analyis = cprd$analysis("ethan")
thyroid_cohort = thyroid_cohort %>%
  analysis$cached("thyroidinv_cohort") %>%
  cbind.data.frame()

View(thyroid_cohort)

nrow(thyroid_cohort %>%
       filter(dm_diag_age_all <= 18) %>%
       filter(!is.na(tsh | ttg))
     )

refined_thyroid_cohort = thyroid_cohort %>%
       filter(dm_diag_age_all <= 18) %>%
       filter(!is.na(tsh | ttg))


remove(refined_thyroid_cohort)
```


``` {r Desc Stats}
#Calculate time_to_thyroid_test and BMI, create new column to classify them by
refined_thyroid_cohort = refined_thyroid_cohort %>%
  mutate(time_to_thyroid_test = ifelse(
                                        !is.na(tsh_date),
                                        difftime(dm_diag_date_all, tsh_date, units="weeks"),
                                        if_else(
                                                !is.na(ttg_date),
                                                difftime(dm_diag_date_all, ttg_date, units="weeks"),
                                                NA
                                              )
                                      )
        ) %>%
  mutate(classification = ifelse(!is.na(tsh) & diabetes_type == "type 1", "tsh1", NA)) %>% # Creating classifications = graphing
  mutate(classification = ifelse(!is.na(tsh) & diabetes_type == "type 2", "tsh2", classification)) %>%
  mutate(classification = ifelse(!is.na(ttg) & diabetes_type == "type 1", "ttg1", classification)) %>% # Creating classifications 
  mutate(classification = ifelse(!is.na(ttg) & diabetes_type == "type 2", "ttg2", classification))
  mutate(bmi = ifelse(is.na(bmi), weight/(height/100), bmi))

View(refined_thyroid_cohort)


# Graphing 
ggplot(
    refined_thyroid_cohort %>%
      mutate(has_insulin = ifelse(has_insulin == 1, "Insulin", "No Insulin")), 
    aes(diabetes_type, ..count..)
  ) +
  geom_bar(aes(fill = classification), position = "dodge")

# Nice Ridgeplot
refined_thyroid_cohort %>%
  ggplot(aes(y = classification)) +
  geom_density_ridges2(
    aes(
    x = hba1c,
    y = classification,
    group = classification,
    fill = classification
  ), 
    alpha = .8, color = "black"
  ) +
  labs(
    x = "hba1c",
    y = "Classification",
    title = "hba1c"
  ) +
  scale_y_discrete(expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0))

nrow(refined_thyroid_cohort %>%
       filter(dm_diag))

nrow(
  refined_thyroid_cohort %>%
    filter(tsh == 1)
  
)

nrow(refined_thyroid_cohort %>%
       filter(!is.na(tsh)) %>%
       filter(dm_diag_age_all < 2) %>%
       filter(tsh == 1)
     )

refined_thyroid_cohort %>%
       filter(dm_diag_age_all < 0) %>%
       select(tsh, ttg)




refined_thyroid_cohort %>%
  select(gender, has_insulin, bmi, time_to_insulin_weeks, hba1c, )

```
