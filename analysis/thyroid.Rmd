---
title: "Thyroid investigation"
author: "Ethan de Villiers"
date: "`r Sys.Date()`"
output: html_document
---

``` {r Init, echo=FALSE} 

library(devtools) # Essential for Aurum integration
library(tidyverse)  # streamlining R coding since 2016

install_github("Exeter-Diabetes/CPRD-analysis-package") # Package created by Exeter University to work with CPRD data
library(aurum)
cprd = CPRDData$new(cprdEnv = "test-remote", cprdConf = '~/RStudio/aurum.yaml')
```

``` {r Pulling Thyroid Cohort}
analyis = cprd$analysis("ethan")
thyroid_cohort = thyroid_cohort %>%
  analysis$cached("thyroidinv_cohort") %>%
  cbind.data.frame()

View(thyroid_cohort)

nrow(thyroid_cohort %>%
       filter(dm_diag_age_all <= 18) %>%
       filter(!is.na(tsh | ttg))
     )

refined_thyroid_cohort = thyroid_cohort %>%
       filter(dm_diag_age_all <= 18) %>%
       filter(!is.na(tsh | ttg))


remove(refined_thyroid_cohort)
```


``` {r Desc Stats}
#Calculate time_to_thyroid_test and BMI, create new column to classify them by
refined_thyroid_cohort = refined_thyroid_cohort %>%
  mutate(time_to_thyroid_test = ifelse(
                                        !is.na(tsh_date),
                                        difftime(dm_diag_date_all, tsh_date, units="weeks"),
                                        if_else(
                                                !is.na(ttg_date),
                                                difftime(dm_diag_date_all, ttg_date, units="weeks"),
                                                NA
                                              )
                                      )
        ) %>%
  mutate(classification = ifelse(!is.na(tsh), "tsh", NA)) %>% # Creating classifications = graphing
  mutate(classification = ifelse(!is.na(ttg), "ttg", classification)) %>% # Creating classifications 
  mutate(bmi = ifelse(is.na(bmi), weight/(height/100), bmi))

View(refined_thyroid_cohort)
# Plotting 



refined_thyroid_cohort %>%
  select(gender, has_insulin, bmi, time_to_insulin_weeks, hba1c, )

```
